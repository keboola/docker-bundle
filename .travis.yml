sudo: required

language: php
php: 5.6

cache:
  directories:
   - vendor

env:
  global:
    # for cc-test-reporter
    - GIT_COMMIT_SHA=$TRAVIS_COMMIT
    - GIT_BRANCH=$TRAVIS_BRANCH

jobs:
  include:
    - stage: tests
      script:
        - export STORAGE_API_TOKEN=$STORAGE_API_TOKEN_ABS; ./vendor/bin/phpunit --testsuite abs-tests --coverage-clover build/logs/clover.xml --debug
        - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
        - chmod +x ./cc-test-reporter
        - ./cc-test-reporter format-coverage --output "coverage/codeclimate.3.json"
        - docker run --rm -e AWS_ACCESS_KEY_ID=$AWS_ECR_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY=$AWS_ECR_SECRET_ACCESS_KEY -v $TRAVIS_BUILD_DIR/coverage/:/data/ quay.io/keboola/aws-cli:latest s3 sync /data/ "s3://docker-runner-logs/coverage/$TRAVIS_BUILD_NUMBER"

notifications:
  email: false
  slack:
    secure: doRb1zL09mK/dGUFgXAz3TqSAkCASbYMQYrGbOtfolIiBHwDHpO8J7QDXo2OHCUvYd4bOMv2HAluooz4nYn50RskUdYDkqUTgDRLVmRwdsH3KiBdQ5awnxfbZTvXPPGKSAbbOaH4AF+ig++I9oBJqzF5pBvcp2sfOiQkIrsjKr8=

branches:
  only:
  - master
  - production
