FROM php:7.4-apache
ENV DEBIAN_FRONTEND noninteractive
ENV COMPOSER_ALLOW_SUPERUSER 1

RUN apt-get update -q \
    && apt-get install -y --no-install-recommends \
        apt-transport-https \
        ca-certificates \
        git \
        gnupg2 \
        libmcrypt-dev \
        libpq-dev \
        openssh-server \
        software-properties-common \
        sudo \
        unzip \
        libzip-dev \
        wget \
        iproute2 \
    && rm -rf /var/lib/apt/lists/*

# install composer
RUN cd \
  && curl -sS https://getcomposer.org/installer | php \
  && ln -s /root/composer.phar /usr/local/bin/composer

# install docker
RUN mkdir -p /etc/apt/keyrings \
  && curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
  && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" \
    | tee /etc/apt/sources.list.d/docker.list > /dev/null \
  && apt-get update \
  && apt-get -y install docker-ce docker-ce-cli containerd.io \
  && rm -rf /var/lib/apt/lists/*

# add SSH user
RUN useradd --create-home --shell /bin/bash --groups sudo php-remote \
    &&  echo "php-remote:php-remote" | chpasswd

# install extensions
RUN docker-php-ext-install zip
#RUN pecl channel-update pecl.php.net \
#    && pecl config-set php_ini /usr/local/etc/php.ini \
#    && yes | pecl install xdebug-2.9.8 \
#    && docker-php-ext-enable xdebug

ENV APACHE_LOCK_DIR=/var/apache/lock/

COPY ./docker-tests/ /buildcode/
WORKDIR /code/

# configure
RUN cp /buildcode/sudoers /etc/ \
    && chmod a+x /buildcode/start.sh \
    && mkdir -p /var/apache/lock \
    && chmod a+rw /var/apache/lock \
    && cp /buildcode/000-default.conf /etc/apache2/sites-available/ \
    && cp /buildcode/php.ini /usr/local/etc/php/

RUN cp /buildcode/sshd_config /etc/ssh/
RUN echo "root:root" | chpasswd
# because of sync actions
RUN usermod -a -G root www-data
RUN chsh -s /bin/bash www-data
RUN echo "www-data ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers

COPY composer.* ./
RUN composer install $COMPOSER_FLAGS --no-scripts --no-autoloader
COPY . .
RUN composer install $COMPOSER_FLAGS --no-scripts
